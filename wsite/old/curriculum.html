<!DOCTYPE html>
<html>
<meta charset="utf-8">

<!-- Filled up during document.ready() https://www.fulek.com/data/api/supit/curriculum-list/en -->
<div id="logInPopup" class="column">
</div>

<body class="fadeInQuick">


	<head>
		<title>
			Algebra University - Curriculum
		</title>

		<link rel="icon" type="image/png" href="../res/img/favicon.png" />
		<link rel="stylesheet" type="text/css" href="../res/custom_style.css" />
		<script src="generic_functions_script.js"></script>

		<script src="../res/jquery-3.7.1.min.js"></script>

		<link rel="stylesheet" href="../res/jquery-ui-1.13.2.custom/jquery-ui.css">
		<script src="../res/jquery-ui-1.13.2.custom/external/jquery/jquery.js"></script>
		<script src="../res/jquery-ui-1.13.2.custom/jquery-ui.js"></script>

		<script>
			var courseLookuplist;
			var semesterTracker;

			$(document).ready(function () {
				var startupScript = document.createElement('script');
				startupScript.src = 'generic_startup_script.js';
				var head = document.getElementsByTagName("head")[0];

				var accessCode = getAccessCode()
				if (!accessCode) {
					reportLogInRequired();
					curriculumReportError("No login token detected");
					head.appendChild(startupScript); // Should be added after we check the login so the login screen doesn't check for it before we even set it.
					return;
				}
				head.appendChild(startupScript);

				courseLookuplist = $('#courseLookup');
				getCurriculumData(accessCode);

				// Hide or show table data based on inputted text
				$('#javascriptCurriculumSearchBarTarget').on('input', function () {
					curriculumDataFilter($('#javascriptCurriculumSearchBarTarget').val());
				}).change();

			});

			function getCurriculumData(accessCode) {
				$.ajax({
					url: "https://www.fulek.com/data/api/supit/curriculum-list/en",
					type: "GET",
					contentType: "application/json",
					headers: {
						Authorization: 'Bearer ' + accessCode
					},
					success: function (response) {
						if (response.isSuccess == true) {
							console.log(response.data);
							console.log(response.data[0].ects);
							getCurriculumDataSuccess(response.data);
							curriculumFinalizeLoad(); // This should be here because it's async.
						}
						else {
							curriculumReportError("Unknown Error");
						};
					},
					error: function () {
						// Fails here if the connection fails
						// Sometimes also fails here if the token expires, but that's not in the project's scope
						curriculumReportError("Connection Failed");
					}
				});
			}

			function getCurriculumDataSuccess(data) {
				// https://stackoverflow.com/questions/979256/sorting-an-array-of-objects-by-property-values -> very cool
				data.sort((a, b) => parseInt(a.semester) - parseInt(b.semester));

				var alternator = false;
				semesterTracker = -Infinity;

				courseLookuplist.empty();

				$(data).each(function () {
					createDataRow(this, alternator);
					alternator = !alternator;
				});
			}

			function createDataRow(data, alternator) {

				var BGType = alternator

				var html = "";
				
				if (data.semester != semesterTracker) {
					semesterTracker = data.semester;
					html += "<h2> SEMESTER " + semesterTracker + "</h2>";
					html += '<div class="row javascriptCurriculumFilterHide" style="border: 1px solid black; border-right: 2px solid black; border-top: 2px solid black;">';
				}else{
					html += '<div class="row javascriptCurriculumFilterHide" style="border: 1px solid black; border-right: 2px solid black;">';
				}

				html += getDataColumn(data.course, BGType, 1);
				html += getDataColumn(data.ects, BGType);
				html += getDataColumn(data.lectures, BGType);
				html += getDataColumn(data.exercises, BGType);
				html += getDataColumn(data.hours, BGType);
				//html += getDataColumn(data.semester, BGType);
				html += getDataColumn(data.type, BGType);

				html += '</div>';

				$('#javascriptCurriculumListTarget').append(html);
				courseLookuplist.append('<option value="' + data.course + '">');
			}

			function getDataColumn(value, BGType, track = 0) {
				var background;
				if (BGType == 0) {
					background = "whiteBG";
				} else if (BGType == 1) {
					background = "blackTranBG";
				}

				var html = '<div class="row curriculumNormalFlex paddingDefault ' + background + ' " ' + 'style="border: 1px solid black; border-top: 0px; border-right: 0px;">';
				if (!track) {
					html += '<div class="row curriculumNormalFlex centered"> ' + value + '</div>';
				} else {
					html += '<div class="row curriculumNormalFlex centered javascriptCurriculumFilterParse"> ' + value + '</div>';
				}
				html += '</div>';

				return html;
			}

			function curriculumDataFilter(filter) {
				filter = filter.toLowerCase();
				console.log(filter);

				$('.javascriptCurriculumFilterParse').each(function () {
					var value = $(this).text().toLowerCase();

					if (value.indexOf(filter) > -1) {
						$(this).parent().parent().css('display', 'flex');
					} else {
						$(this).parent().parent().css('display', 'none');
					}
				})

				// window.scrollTo(0, 0);
				// Sometimes the site scrolls when the filter runs, so the autocomplete window (below the autocomplete field) shows at the wrong place.
				// I applied a bandaid in content, but I'm not happy with it.
			}

			function curriculumFinalizeLoad(){
				$("#javascriptCurriculumLoaderTarget").css("display", "none");
			}

			function curriculumReportError(message){
				$("#javascriptCurriculumLoadingIconTarget").text(message);
			}
		</script>

	</head>


	<!-- Filled up during $(document).ready -->
	<div id="navBar">
	</div>
	
	<!--Filled up during document.ready()-->
	<div id="scrollToTop" class="column">
	</div>

	<style>
		.curriculumNormalFlex {
			flex: 1 0 6em;
			gap: 1px;
			min-width: 6em;
		}

		.curriculumBorderTopLeft {
			border: 1px solid black;
			border-top: 0px;
			border-right: 0px;
		}
	</style>

	<div id="content" class="column">

		<div class="column paddingDefault algebraBG">
			<h1>Algebra Course Lookup</h1>
		</div>

		<!-- Forced height to "fix" the autocomplete selection bug -->
		<div style="min-height: 95vh;" class="column">
			<div class="column blackBG sticky" style="max-height: 30vh; overflow-y: auto;">
				<div class="column marginDefaultHalf" style="margin-bottom: 0px;">

					<input id="javascriptCurriculumSearchBarTarget" class="marginDefaultHalf roundedBorderHalf centered"
						type="text" placeholder="Course Name Search" list="courseLookup">

					<datalist id="courseLookup">
					</datalist>

					<div class="row"
						style="border: 2px solid black; border-bottom: 1px solid black; border-left: 1px solid black;">

						<div class="row curriculumNormalFlex curriculumBorderTopLeft paddingDefault">
							Course Name
						</div>
						<div class="row curriculumNormalFlex curriculumBorderTopLeft paddingDefault algebraOrangeBG">
							ECTS
						</div>

						<div class="row curriculumNormalFlex curriculumBorderTopLeft paddingDefault">
							Lectures
						</div>
						<div class="row curriculumNormalFlex curriculumBorderTopLeft paddingDefault algebraOrangeBG">
							Exercises
						</div>

						<div class="row curriculumNormalFlex curriculumBorderTopLeft paddingDefault">
							Total Hours
						</div>
						<div class="row curriculumNormalFlex curriculumBorderTopLeft paddingDefault algebraOrangeBG">
							Type
						</div>
					</div>

				</div>
			</div>

			<div id="javascriptCurriculumLoaderTarget" class="simpleSpacer column">
				<div class="simpleSpacer"></div>
				<div id="javascriptCurriculumLoadingIconTarget">
					Please wait...
					<div class="row">
						<div class="loader"></div>
					</div>
				</div>
				<div style="flex-grow: 6;"></div>
			</div>

			<!-- Filled up during $(document).ready -->
			<div id="javascriptCurriculumListTarget" class="column whiteBG marginDefaultHalf">
			</div>
			
		</div>
	</div>


	<div class="simpleSpacer"></div>


	<!-- Filled up during $(document).ready -->
	<footer id="footer">
	</footer>

</body>

</html>